services:
  # --- JAVA SERVICES WITH BIND MOUNTS ---

  challenge:
    container_name: challenge
    image: maven:3.9.5-eclipse-temurin-17
    working_dir: /app
    command: ./mvnw spring-boot:run
    ports:
      - "9006:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=${POSTGRES_URL}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./challenge:/app
      - maven-repo:/root/.m2
    networks:
      - app-network

  community:
    container_name: community
    image: maven:3.9.5-eclipse-temurin-17
    working_dir: /app
    command: ./mvnw spring-boot:run
    ports:
      - "9004:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=${POSTGRES_URL}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./community:/app
      - maven-repo:/root/.m2
    networks:
      - app-network

  learn:
    container_name: learn
    image: maven:3.9.5-eclipse-temurin-17
    working_dir: /app
    command: ./mvnw spring-boot:run
    ports:
      - "9002:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=${POSTGRES_URL}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - INTERNAL_GATEWAY_SECRET=${INTERNAL_GATEWAY_SECRET}
    volumes:
      - ./learn:/app
      - maven-repo:/root/.m2
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      migrate-learn:
        condition: service_completed_successfully

  portal:
    container_name: portal
    image: maven:3.9.5-eclipse-temurin-21
    working_dir: /app
    command: ./mvnw spring-boot:run
    ports:
      - "9000:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=${POSTGRES_URL}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - INTERNAL_GATEWAY_SECRET=${INTERNAL_GATEWAY_SECRET}
    volumes:
      - ./portal:/app
      - maven-repo:/root/.m2
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      migrate-portal:
        condition: service_completed_successfully

  gateway:
    container_name: gateway
    image: maven:3.9.5-eclipse-temurin-17
    working_dir: /app
    command: ./mvnw spring-boot:run
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - IDENTITY_SERVICE_URL=http://identity:8080
      - LEARN_SERVICE_URL=http://learn:8080
      - PORTAL_SERVICE_URL=http://portal:8080
      - INTERNAL_GATEWAY_SECRET=${INTERNAL_GATEWAY_SECRET}
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=${POSTGRES_URL}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./gateway:/app
      - maven-repo:/root/.m2
    networks:
      - app-network

  identity:
    container_name: identity
    image: maven:3.9.5-eclipse-temurin-21
    working_dir: /app
    command: ./mvnw spring-boot:run
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - INTERNAL_GATEWAY_SECRET=${INTERNAL_GATEWAY_SECRET}
      - DATABASE_URL=${POSTGRES_URL}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./identity:/app
      - maven-repo:/root/.m2
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      migrate-identity:
        condition: service_completed_successfully

  # --- INFRASTRUCTURE ---

  postgres:
    container_name: postgres
    image: postgres:16-alpine
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  migrate-identity:
    container_name: migrate-identity
    image: flyway/flyway:11
    command: -schemas=identity -table=identity_schema_history -locations=filesystem:/flyway/sql migrate
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB}
      FLYWAY_USER: ${POSTGRES_USER}
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./infra/migrations/identity:/flyway/sql
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network

  migrate-portal:
    container_name: migrate-portal
    image: flyway/flyway:11
    command: -schemas=portal -table=portal_schema_history -locations=filesystem:/flyway/sql migrate
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB}
      FLYWAY_USER: ${POSTGRES_USER}
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./infra/migrations/portal:/flyway/sql
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network

  migrate-learn:
    container_name: migrate-learn
    image: flyway/flyway:11
    command: -schemas=learn -table=learn_schema_history -locations=filesystem:/flyway/sql migrate
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB}
      FLYWAY_USER: ${POSTGRES_USER}
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./infra/migrations/learn:/flyway/sql
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network

volumes:
  pgdata:
  maven-repo: # This named volume persists your jars across all containers

networks:
  app-network:
    driver: bridge
